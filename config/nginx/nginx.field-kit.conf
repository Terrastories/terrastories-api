# =============================================================================
# NGINX CONFIGURATION - FIELD KIT
# Simplified configuration for offline field deployment
# No SSL, optimized for low-resource environments
# =============================================================================

user nginx;
worker_processes 1;  # Single process for low-resource devices
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 256;  # Reduced for field deployment
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Basic optimizations
    sendfile on;
    tcp_nopush on;
    keepalive_timeout 30;  # Shorter timeout
    server_tokens off;
    
    # Smaller buffers for resource constraints
    client_max_body_size 20M;
    client_body_buffer_size 64k;
    
    # Light compression
    gzip on;
    gzip_vary on;
    gzip_comp_level 3;  # Lower compression for CPU savings
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        text/xml;
    
    # Simple logging
    log_format simple '$remote_addr - $request_time - "$request" $status';
    access_log /var/log/nginx/access.log simple;
    
    # Basic rate limiting
    limit_req_zone $binary_remote_addr zone=api:1m rate=5r/s;
    
    # Upstream servers
    upstream api {
        server api:3000;
    }
    
    upstream tileserver {
        server tileserver:8080;
    }
    
    # Main HTTP server (no HTTPS in field deployment)
    server {
        listen 80;
        server_name _;
        
        # Basic security headers
        add_header X-Frame-Options SAMEORIGIN always;
        add_header X-Content-Type-Options nosniff always;
        
        # Root redirect
        location / {
            return 302 /api/v1/;
        }
        
        # API proxy
        location /api/ {
            limit_req zone=api burst=10 nodelay;
            
            proxy_pass http://api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # Shorter timeouts for field conditions
            proxy_connect_timeout 3s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # File uploads
        location /api/v1/upload {
            proxy_pass http://api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            # Extended timeout for uploads
            proxy_send_timeout 180s;
            proxy_read_timeout 180s;
        }
        
        # Serve uploaded files
        location /uploads/ {
            alias /usr/share/nginx/html/uploads/;
            expires 7d;
            
            # Prevent execution
            location ~* \.(php|php5|phtml|pl|py|jsp|asp|sh|cgi)$ {
                deny all;
            }
        }
        
        # Tile server - critical for offline maps
        location /tiles/ {
            proxy_pass http://tileserver/;
            proxy_set_header Host $host;
            
            # Long cache for tiles in offline mode
            expires 30d;
            add_header Cache-Control "public";
        }
        
        # Health check
        location /health {
            access_log off;
            proxy_pass http://api/health;
        }
        
        # Swagger documentation
        location /docs {
            proxy_pass http://api/docs;
            proxy_set_header Host $host;
        }
        
        # Block sensitive files
        location ~ /\. {
            deny all;
        }
    }
}